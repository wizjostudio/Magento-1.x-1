<?php
/**
*
*
* NOTICE OF LICENSE
*
* This source file is subject to the Academic Free License (AFL 3.0)
* that is bundled with this package in the file LICENSE.txt.
* It is also available through the world-wide-web at this URL:
* http://opensource.org/licenses/afl-3.0.php
* If you did not receive a copy of the license and are unable to
* obtain it through the world-wide-web, please send an email
* to tech@dotpay.pl so we can send you a copy immediately.
*
* DISCLAIMER 
*
* Do not edit or add to this file if you wish to upgrade Drupal Commerce to newer
* versions in the future. If you wish to customize Drupal Commerce for your
* needs please refer to http://www.dotpay.pl for more information.
*
*  @author    Dotpay Team <tech@dotpay.pl>
*  @copyright Dotpay
*  @license   http://opensource.org/licenses/afl-3.0.php  Academic Free License (AFL 3.0)
*
*/
?>

<?php if($this->isWidgetMode()): ?>
<h3><?php echo Mage::helper('dotpay')->__('Please select your payment channel'); ?></h3>
<link href="<?php echo $this->getMethodInstance()->getRedirectUrl(); ?>widget/payment_widget.min.css" rel="stylesheet">
<script id="dotpay-payment-script" src="<?php echo $this->getMethodInstance()->getRedirectUrl(); ?>widget/payment_widget.js"></script>
<script type="text/javascript">
    var dotpayWidgetConfig = {
        sellerAccountId: '<?php echo $this->getSellerId(); ?>',
        widgetFormContainerClass: 'dotpay-form-widget-container'
    };
</script>
<style>
    .dotpay-form-widget-container img, .selectedChannelContainer img {
        display: inline;
    }
    
    #dotpay_dotpay_redirection_form span.field-row {
        display: inline;
    }

    .selected-channel-message {
        display: none;
        font-size: 17px;
        text-decoration: none;
        margin-bottom: 5px;
    }

    .selected-channel-message a {
        text-decoration: none;
    }

    .selectedChannelContainer {
        max-width: none !important;
        cursor: default;
        display: none;
        margin-bottom: 15px !important;
    }

    .selectedChannelContainer hr {
        display: block;
    }
</style>
<script type="text/javascript">
    (function($) {
        var defaults = {
            channelsContainerClass: "dotpay-channels-selection",
            channelChangeClass: "channel-selected-change",
            selectedChannelContainerClass: "selectedChannelContainer",
            messageContainerClass: "selected-channel-message",
            collapsibleWidgetTitleClass: "collapsibleWidgetTitle",
            widgetContainerClass: "dotpay-form-widget-container"
        };
        var settings = {};

        $.dpCollapsibleWidget = function(options) {
            if(window.dotpayRegisterWidgetEvent == undefined) {
                window.dotpayRegisterWidgetEvent = true;
                settings = $.extend( {}, defaults, options );
                connectEventToWidget();
                $('.'+settings.selectedChannelContainerClass+', .'+settings.messageContainerClass).click(function(e){
                    e.stopPropagation();
                    e.preventDefault();
                    return false;
                });
                $('.'+settings.channelChangeClass).click(onChangeSelectedChannel);
            }
            return this;
        }
        function connectEventToWidget() {
            $('.channel-container').on('click', function(e) {
                $('.channel-input', this).prop('checked', true);
                var id = $(this).find('.channel-input').val();
                if(id == undefined)
                    return false;
                var container = copyChannelContainer(id);
                $('.'+settings.selectedChannelContainerClass+' div').remove();
                container.insertBefore($('.'+settings.selectedChannelContainerClass+' hr'));
                toggleWidgetView();
                e.preventDefault();
            });
        }

        function copyChannelContainer(id) {
            var container = $('.'+settings.widgetContainerClass+' #'+id).parents('.channel-container').clone();
            container.find('.tooltip').remove();
            container.find('.input-container').remove();
            container.removeClass('not-online');
            return container;
        }

        function onChangeSelectedChannel(e) {
            toggleWidgetView();
            e.stopPropagation();
            e.preventDefault();
            return false;
        }

        function toggleWidgetView() {
            $('.'+settings.collapsibleWidgetTitleClass+', .'+settings.selectedChannelContainerClass+' hr, .'+settings.widgetContainerClass).animate(
                {
                    height: "toggle",
                    opacity: "toggle"
                }, {
                    duration: "slow"
                }
            );
            $('.'+settings.messageContainerClass+',.'+settings.selectedChannelContainerClass).show();
        }
    })(jQuery);

    jQuery(document).ready(function(){
        setTimeout(function(){
            jQuery.dpCollapsibleWidget();
            if(jQuery('#dotpay_dotpay_redirection_form #chk').val() == '')
                jQuery('#dotpay_dotpay_redirection_form #submit').attr('disabled', true);
            jQuery('.channel-container').click(function(){
                jQuery('#dotpay_dotpay_redirection_form #submit').attr('disabled', true);
                jQuery.post('<?php echo $this->getSignatureUrl(); ?>',
                    {"order":<?php echo $this->getOrderId(); ?>, "channel":jQuery('.channel-input:checked').val()},
                    function(chk){
                        jQuery('#dotpay_dotpay_redirection_form #chk').val(chk);
                        jQuery('#dotpay_dotpay_redirection_form #submit').attr('disabled', false);
                    }
                );
            });
        }, 600);
    });
</script>
<?php else: ?>
<script>
    jQuery(document).ready(function(){
        jQuery('#dotpay_dotpay_redirection_form').submit();
    });
</script>
<?php endif; ?>
<?php echo $this->getForm()->toHtml() ?>